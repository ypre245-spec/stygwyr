import React, { useState, useRef, useEffect } from 'react';
import { Camera, Upload, Download, RefreshCw, User, Layers, Check, AlertCircle, Move, ZoomIn, Scissors, Palette, Settings, Sliders, Image as ImageIcon, Shirt } from 'lucide-react';

// --- Constants ---
const apiKey = ""; 

// Paper Sizes @ 300 DPI
const SIZES = {
  '5R': { width: 1500, height: 2100, label: '5R (5" x 7")' },
  'A4': { width: 3508, height: 2480, label: 'A4 Landscape (11.7" x 8.3")' }
};

// Photo Sizes @ 300 DPI
const ID_2X2_SIZE = 600; // 2 inches
const ID_1X1_SIZE = 300; // 1 inch
const UI_CROP_SIZE = 320; // UI display size

export default function IDPhotoBooth() {
  // --- State ---
  const [originalImage, setOriginalImage] = useState(null); 
  const [croppedImage, setCroppedImage] = useState(null); 
  const [processedImage, setProcessedImage] = useState(null); 
  const [previewUrl, setPreviewUrl] = useState(''); 
  
  const [isProcessing, setIsProcessing] = useState(false);
  const [error, setError] = useState('');
  const [step, setStep] = useState(1); // 1: Upload, 1.5: Crop, 2: Config/Process, 3: Edit/Print

  // Crop State
  const [cropOffset, setCropOffset] = useState({ x: 0, y: 0 });
  const [zoom, setZoom] = useState(1);
  const [dragStart, setDragStart] = useState(null);

  // Configuration State (Step 2)
  const [gender, setGender] = useState('male'); 
  const [bgColor, setBgColor] = useState('white'); // 'white', 'blue', 'red'
  const [attireType, setAttireType] = useState('default'); // 'default', 'formal', 'medical', 'custom'
  const [customAttire, setCustomAttire] = useState('');

  // Editing State (Step 3)
  const [paperSize, setPaperSize] = useState('5R');
  const [brightness, setBrightness] = useState(100); // %
  const [contrast, setContrast] = useState(100); // %

  // Refs
  const canvasRef = useRef(null);
  const cropCanvasRef = useRef(null);
  const fileInputRef = useRef(null);
  const imageRef = useRef(null);

  // --- File Handlers ---

  const handleDragOver = (e) => { e.preventDefault(); e.stopPropagation(); };
  const handleDrop = (e) => { 
    e.preventDefault(); e.stopPropagation();
    if (e.dataTransfer.files?.[0]) processFile(e.dataTransfer.files[0]);
  };
  const handleFileSelect = (e) => {
    if (e.target.files?.[0]) processFile(e.target.files[0]);
  };

  const processFile = (file) => {
    if (!file.type.startsWith('image/')) {
      setError('Please upload a valid image file (JPG or PNG).');
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      setOriginalImage(e.target.result);
      setStep(1.5);
      setError('');
      setCropOffset({ x: 0, y: 0 });
      setZoom(1);
    };
    reader.readAsDataURL(file);
  };

  // --- Crop Logic ---

  const handleMouseDown = (e) => setDragStart({ x: e.clientX - cropOffset.x, y: e.clientY - cropOffset.y });
  const handleMouseMove = (e) => {
    if (dragStart) setCropOffset({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
  };
  const handleMouseUp = () => setDragStart(null);
  
  const handleTouchStart = (e) => {
    const touch = e.touches[0];
    setDragStart({ x: touch.clientX - cropOffset.x, y: touch.clientY - cropOffset.y });
  };
  const handleTouchMove = (e) => {
    if (dragStart) {
      const touch = e.touches[0];
      setCropOffset({ x: touch.clientX - dragStart.x, y: touch.clientY - dragStart.y });
    }
  };

  const confirmCrop = () => {
    const canvas = cropCanvasRef.current;
    const ctx = canvas.getContext('2d');
    const image = imageRef.current;
    if (!image || !canvas || !image.parentElement) return;

    const containerRect = image.parentElement.getBoundingClientRect();
    const imageRect = image.getBoundingClientRect();
    const outputSize = 800; 
    canvas.width = outputSize;
    canvas.height = outputSize;

    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, outputSize, outputSize);

    const ratio = outputSize / containerRect.width;
    const x = (imageRect.left - containerRect.left) * ratio;
    const y = (imageRect.top - containerRect.top) * ratio;
    const width = imageRect.width * ratio;
    const height = imageRect.height * ratio;

    ctx.drawImage(image, x - 1, y - 1, width + 2, height + 2);

    setCroppedImage(canvas.toDataURL('image/jpeg', 0.95));
    setStep(2); 
  };

  // --- Prompt Generation ---

  const getAttireDescription = () => {
    if (attireType === 'custom') return customAttire || "formal business attire";
    
    if (gender === 'male') {
      switch (attireType) {
        case 'formal': return "black formal tuxedo with a bow tie";
        case 'medical': return "white medical doctor's coat with a shirt and tie underneath";
        case 'casual': return "smart casual collared button-down shirt";
        default: return "dark navy blue formal business suit with a white collared shirt and tie";
      }
    } else {
      switch (attireType) {
        case 'formal': return "elegant black evening formal blouse";
        case 'medical': return "white medical doctor's coat";
        case 'casual': return "smart casual blouse";
        default: return "black formal business blazer with a white inner blouse";
      }
    }
  };

  // --- API Logic ---

  const generateIDPhoto = async () => {
    if (!croppedImage) return; 

    setIsProcessing(true);
    setError('');

    try {
      const base64Data = croppedImage.split(',')[1];
      const attireDesc = getAttireDescription();
      const colorDesc = bgColor === 'white' ? 'pure white' : bgColor === 'blue' ? 'royal blue' : 'red';

      const promptText = `
        Act as a professional photo studio editor. Process this ID photo:
        1. BACKGROUND: Change background to a clean, solid ${colorDesc}.
        2. ATTIRE: Change clothing to a ${attireDesc}.
        3. ENHANCEMENT: Apply "studio finish":
           - Smooth skin tone/texture subtly.
           - Softbox lighting (no harsh shadows).
           - Fix white balance/color for a vibrant look.
           - Sharpen eyes.
        4. IDENTITY: CRITICAL. Do NOT alter facial structure or identity.
        5. COMPOSITION: MAINTAIN existing square framing. Do not zoom.
      `;

      const payload = {
        contents: [{
          parts: [{ text: promptText }, { inlineData: { mimeType: "image/jpeg", data: base64Data } }]
        }],
        generationConfig: { responseModalities: ["TEXT", "IMAGE"] }
      };

      const fetchWithRetry = async (retries = 3, delay = 1000) => {
        try {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`,
            { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }
          );
          if (response.status === 401) throw new Error("Invalid API Key.");
          if (!response.ok) throw new Error(`API Error: ${response.status}`);
          return await response.json();
        } catch (err) {
          if (retries > 0 && !err.message.includes("Invalid API Key")) {
            await new Promise(resolve => setTimeout(resolve, delay));
            return fetchWithRetry(retries - 1, delay * 2);
          }
          throw err;
        }
      };

      const result = await fetchWithRetry();
      const generatedBase64 = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
      
      if (generatedBase64) {
        setProcessedImage(`data:image/jpeg;base64,${generatedBase64}`);
        setStep(3);
      } else {
        throw new Error("No image data returned from AI.");
      }
    } catch (err) {
      console.error(err);
      setError(err.message || "Failed to process image.");
    } finally {
      setIsProcessing(false);
    }
  };

  // --- Layout & Rendering Logic ---

  useEffect(() => {
    if (step === 3 && processedImage && canvasRef.current) {
      renderSheet();
    }
  }, [step, processedImage, paperSize, brightness, contrast]);

  const renderSheet = () => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = () => {
      const currentPaper = SIZES[paperSize];
      canvas.width = currentPaper.width;
      canvas.height = currentPaper.height;
      
      // Background
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, currentPaper.width, currentPaper.height);

      // Draw Function with Filters
      const drawImageSimple = (x, y, size) => {
        ctx.save();
        // Apply Filters
        ctx.filter = `brightness(${brightness}%) contrast(${contrast}%)`;
        ctx.drawImage(img, 0, 0, img.width, img.height, x, y, size, size);
        ctx.restore(); // Restore to remove filter for stroke

        // Cut Guide
        ctx.strokeStyle = '#cbd5e1'; 
        ctx.lineWidth = 1;
        ctx.strokeRect(x, y, size, size); 
      };

      // --- Layout Engine ---
      const spacing = 30;
      
      // Calculate Content Dimensions
      // 2x2 Row: 600 + 30 + 600 = 1230
      // 1x1 Row: 300*4 + 30*3 = 1290
      const contentWidth2x2 = (ID_2X2_SIZE * 2) + spacing;
      const contentWidth1x1 = (ID_1X1_SIZE * 4) + (spacing * 3);
      
      let startX2x2, startX1x1;

      if (paperSize === 'A4') {
        // Align content to the center of the LEFT HALF of the page
        // This leaves the right half completely free for other use
        const sectionWidth = currentPaper.width / 2;
        startX2x2 = (sectionWidth - contentWidth2x2) / 2;
        startX1x1 = (sectionWidth - contentWidth1x1) / 2;
        
        // Draw a dashed guide line at the center fold
        ctx.beginPath();
        ctx.moveTo(sectionWidth, 0);
        ctx.lineTo(sectionWidth, currentPaper.height);
        ctx.strokeStyle = '#94a3b8'; 
        ctx.lineWidth = 2;
        ctx.setLineDash([20, 20]);
        ctx.stroke();
        ctx.setLineDash([]); // Reset dash
      } else {
        // Standard Centering for 5R
        startX2x2 = (currentPaper.width - contentWidth2x2) / 2;
        startX1x1 = (currentPaper.width - contentWidth1x1) / 2;
      }

      // Vertical Layout
      const contentHeight = (ID_2X2_SIZE * 2) + spacing + 60 + (ID_1X1_SIZE * 2) + spacing;
      let currentY = (currentPaper.height - contentHeight) / 2;

      // Draw 2x2s (2 Rows)
      drawImageSimple(startX2x2, currentY, ID_2X2_SIZE);
      drawImageSimple(startX2x2 + ID_2X2_SIZE + spacing, currentY, ID_2X2_SIZE);
      currentY += ID_2X2_SIZE + spacing;

      drawImageSimple(startX2x2, currentY, ID_2X2_SIZE);
      drawImageSimple(startX2x2 + ID_2X2_SIZE + spacing, currentY, ID_2X2_SIZE);
      currentY += ID_2X2_SIZE + 60;

      // Draw 1x1s (2 Rows)
      const drawRow1x1 = (y) => {
        for (let i = 0; i < 4; i++) {
          drawImageSimple(startX1x1 + (i * (ID_1X1_SIZE + spacing)), y, ID_1X1_SIZE);
        }
      };
      
      drawRow1x1(currentY);
      currentY += ID_1X1_SIZE + spacing;
      drawRow1x1(currentY);

      setPreviewUrl(canvas.toDataURL('image/jpeg', 0.8));
    };
    img.src = processedImage;
  };

  // --- Downloads ---

  const downloadSheet = () => {
    const link = document.createElement('a');
    link.download = `ID-Photos-${paperSize}-Sheet.jpg`;
    link.href = canvasRef.current.toDataURL('image/jpeg', 1.0);
    link.click();
  };

  const downloadDigital = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    img.onload = () => {
      canvas.width = 800; // High quality digital copy
      canvas.height = 800;
      ctx.fillStyle = bgColor; // Fill BG color to be safe
      ctx.fillRect(0,0,800,800);
      ctx.filter = `brightness(${brightness}%) contrast(${contrast}%)`;
      ctx.drawImage(img, 0, 0, 800, 800);
      
      const link = document.createElement('a');
      link.download = 'ID-Photo-Digital-Copy.jpg';
      link.href = canvas.toDataURL('image/jpeg', 0.95);
      link.click();
    };
    img.src = processedImage;
  };

  const reset = () => {
    setOriginalImage(null); setCroppedImage(null); setProcessedImage(null); setPreviewUrl('');
    setStep(1); setError(''); setZoom(1); setBrightness(100); setContrast(100);
  };

  // --- Render ---

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
      
      {/* Navbar */}
      <nav className="bg-white border-b border-slate-200 px-6 py-4 shadow-sm sticky top-0 z-10">
        <div className="max-w-5xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white">
              <Camera size={24} />
            </div>
            <div>
              <h1 className="text-xl font-bold tracking-tight text-slate-900 leading-none">ID Studio</h1>
              <p className="text-xs text-slate-500 font-medium">Pro Edition</p>
            </div>
          </div>
          <div className="hidden sm:flex gap-6 text-sm font-medium text-slate-500">
            {[1, 1.5, 2, 3].map((s, i) => (
              <span key={s} className={step >= s ? "text-blue-600" : ""}>{i+1}. {['Upload','Crop','Config','Print'][i]}</span>
            ))}
          </div>
        </div>
      </nav>

      {/* Main Content */}
      <main className="max-w-5xl mx-auto px-6 py-10">
        {error && <div className="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center gap-3"><AlertCircle size={20} /><p>{error}</p></div>}

        {/* STEP 1: Upload */}
        {step === 1 && (
          <div className="max-w-xl mx-auto bg-white rounded-2xl shadow-xl p-8 border border-slate-100 text-center">
            <h2 className="text-2xl font-bold mb-2">Upload Selfie</h2>
            <p className="text-slate-500 mb-8">Professional ID photos in seconds.</p>
            <div 
              className="border-2 border-dashed border-slate-300 rounded-xl p-10 cursor-pointer hover:bg-slate-50 transition-colors"
              onDragOver={handleDragOver} onDrop={handleDrop} onClick={() => fileInputRef.current.click()}
            >
              <Upload className="mx-auto h-12 w-12 text-slate-400 mb-4" />
              <p className="text-lg font-medium text-slate-700">Drag & drop or click to browse</p>
              <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileSelect} />
            </div>
          </div>
        )}

        {/* STEP 1.5: Crop */}
        {step === 1.5 && originalImage && (
          <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-8 border border-slate-100 text-center">
            <h2 className="text-xl font-bold mb-4">Crop Photo</h2>
            <p className="text-slate-500 text-sm mb-6">Drag and zoom to frame your face perfectly.</p>
            <div className="flex justify-center mb-6">
              <div 
                className="relative w-80 h-80 bg-slate-900 overflow-hidden rounded-lg shadow-inner cursor-move touch-none"
                onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp}
                onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleMouseUp}
              >
                <img 
                  ref={imageRef} src={originalImage} alt="Crop"
                  className="absolute max-w-none origin-center pointer-events-none select-none"
                  style={{ top: '50%', left: '50%', transform: `translate(-50%, -50%) translate(${cropOffset.x}px, ${cropOffset.y}px) scale(${zoom})`, minWidth: '100%', minHeight: '100%' }}
                />
                <div className="absolute inset-0 border-2 border-white/50 pointer-events-none" />
                <div className="absolute top-1/3 w-full h-px bg-white/30 pointer-events-none" />
                <div className="absolute top-2/3 w-full h-px bg-white/30 pointer-events-none" />
                <div className="absolute left-1/3 h-full w-px bg-white/30 pointer-events-none" />
                <div className="absolute left-2/3 h-full w-px bg-white/30 pointer-events-none" />
              </div>
            </div>
            <div className="max-w-xs mx-auto mb-8 flex items-center gap-3">
              <ZoomIn size={16} className="text-slate-500" />
              <input type="range" min="0.5" max="3" step="0.1" value={zoom} onChange={(e) => setZoom(parseFloat(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
            </div>
            <div className="flex gap-4 justify-center">
              <button onClick={() => setStep(1)} className="px-6 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg">Back</button>
              <button onClick={confirmCrop} className="px-8 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-lg flex items-center gap-2"><Scissors size={18} /> Crop & Continue</button>
            </div>
          </div>
        )}

        {/* STEP 2: Configure */}
        {step === 2 && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
            <div className="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden p-8 flex justify-center bg-slate-100">
              <img src={croppedImage} alt="Crop" className="max-h-80 rounded-lg shadow-md object-contain" />
            </div>
            <div className="flex flex-col gap-6">
              <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                <h3 className="text-xl font-bold mb-6 flex items-center gap-2"><Settings size={20} /> Configuration</h3>
                
                {/* Gender */}
                <div className="mb-6">
                  <label className="text-xs font-bold uppercase text-slate-500 mb-2 block">1. Gender</label>
                  <div className="flex gap-3">
                    {['male', 'female'].map(g => (
                      <button key={g} onClick={() => setGender(g)} className={`flex-1 py-3 rounded-xl border-2 font-medium capitalize ${gender === g ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-200 hover:border-blue-300'}`}>{g}</button>
                    ))}
                  </div>
                </div>

                {/* Background Color */}
                <div className="mb-6">
                  <label className="text-xs font-bold uppercase text-slate-500 mb-2 block">2. Background Color</label>
                  <div className="flex gap-3">
                    {[
                      { id: 'white', bg: 'bg-white', border: 'border-slate-200' },
                      { id: 'blue', bg: 'bg-blue-600', border: 'border-blue-600' },
                      { id: 'red', bg: 'bg-red-600', border: 'border-red-600' }
                    ].map(c => (
                      <button 
                        key={c.id} 
                        onClick={() => setBgColor(c.id)} 
                        className={`flex-1 h-12 rounded-xl border-2 flex items-center justify-center transition-all ${bgColor === c.id ? 'ring-2 ring-offset-2 ring-blue-500 scale-105' : 'opacity-70 hover:opacity-100'} ${c.bg} ${c.border}`}
                      >
                        {bgColor === c.id && <Check size={20} className={c.id === 'white' ? 'text-slate-800' : 'text-white'} />}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Attire */}
                <div className="mb-8">
                  <label className="text-xs font-bold uppercase text-slate-500 mb-2 block">3. Attire Style</label>
                  <div className="grid grid-cols-2 gap-2 mb-3">
                    {[
                      { id: 'default', label: 'Standard Suit' },
                      { id: 'formal', label: 'Formal/Black' },
                      { id: 'medical', label: 'Medical Coat' },
                      { id: 'casual', label: 'Smart Casual' },
                      { id: 'custom', label: 'Custom...' }
                    ].map(a => (
                      <button key={a.id} onClick={() => setAttireType(a.id)} className={`py-2 px-3 text-sm rounded-lg border transition-all ${attireType === a.id ? 'bg-slate-800 text-white border-slate-800' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>{a.label}</button>
                    ))}
                  </div>
                  {attireType === 'custom' && (
                    <input 
                      type="text" 
                      placeholder="E.g., Red turtleneck sweater" 
                      value={customAttire}
                      onChange={(e) => setCustomAttire(e.target.value)}
                      className="w-full p-3 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                  )}
                </div>

                <button 
                  onClick={generateIDPhoto}
                  disabled={isProcessing}
                  className={`w-full py-4 px-6 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 transition-all ${isProcessing ? 'bg-slate-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
                >
                  {isProcessing ? <><RefreshCw className="animate-spin" /> Processing...</> : <><RefreshCw /> Generate Photos</>}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* STEP 3: Edit & Print */}
        {step === 3 && (
          <div className="animate-fade-in grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Left: Controls */}
            <div className="lg:col-span-1 space-y-6">
              
              {/* Paper Settings */}
              <div className="bg-white rounded-2xl shadow-md p-6 border border-slate-100">
                <h3 className="text-sm uppercase tracking-wider font-bold text-slate-400 mb-4 flex items-center gap-2"><Layers size={16}/> Paper Size</h3>
                <div className="flex gap-2 p-1 bg-slate-100 rounded-xl">
                  {Object.keys(SIZES).map(s => (
                    <button key={s} onClick={() => setPaperSize(s)} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${paperSize === s ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>{s}</button>
                  ))}
                </div>
                <p className="text-xs text-center mt-2 text-slate-400">{SIZES[paperSize].label}</p>
              </div>

              {/* Adjustments */}
              <div className="bg-white rounded-2xl shadow-md p-6 border border-slate-100">
                <h3 className="text-sm uppercase tracking-wider font-bold text-slate-400 mb-4 flex items-center gap-2"><Sliders size={16}/> Adjustments</h3>
                <div className="space-y-4">
                  <div>
                    <div className="flex justify-between text-xs font-medium text-slate-600 mb-1"><span>Brightness</span><span>{brightness}%</span></div>
                    <input type="range" min="80" max="120" value={brightness} onChange={(e) => setBrightness(e.target.value)} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                  </div>
                  <div>
                    <div className="flex justify-between text-xs font-medium text-slate-600 mb-1"><span>Contrast</span><span>{contrast}%</span></div>
                    <input type="range" min="80" max="120" value={contrast} onChange={(e) => setContrast(e.target.value)} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                  </div>
                </div>
              </div>

              {/* Downloads */}
              <div className="space-y-3">
                <button onClick={downloadSheet} className="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 flex items-center justify-center gap-2 transition-transform active:scale-95">
                  <Download size={18} /> Download Printable Sheet
                </button>
                <button onClick={downloadDigital} className="w-full bg-white text-slate-700 font-bold py-3.5 rounded-xl border-2 border-slate-200 hover:border-slate-300 hover:bg-slate-50 flex items-center justify-center gap-2 transition-colors">
                  <ImageIcon size={18} /> Download Digital Copy
                </button>
                <button onClick={reset} className="w-full text-sm text-slate-400 hover:text-red-500 py-2">Start Over</button>
              </div>
            </div>

            {/* Right: Preview */}
            <div className="lg:col-span-2">
               <div className="bg-slate-200 rounded-2xl p-4 overflow-auto shadow-inner h-[700px] flex justify-center items-start">
                  <div className="bg-white shadow-2xl relative transition-all duration-300" style={{ width: paperSize === '5R' ? '400px' : '500px', minHeight: '560px' }}>
                     {!previewUrl && <div className="absolute inset-0 flex items-center justify-center text-slate-300">Generating Preview...</div>}
                     <img src={previewUrl} alt="Preview" className="w-full h-auto relative z-10" />
                  </div>
               </div>
               <p className="text-center text-xs text-slate-400 mt-2">Showing {SIZES[paperSize].label} Layout @ 300 DPI</p>
            </div>
          </div>
        )}

      </main>
      
      {/* Hidden Canvases */}
      <canvas ref={canvasRef} className="hidden" />
      <canvas ref={cropCanvasRef} className="hidden" />

    </div>
  );
}
